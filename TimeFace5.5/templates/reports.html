{% extends "base.html" %}

{% block title %}Reports - Attendance Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-chart-bar me-2"></i>Reports & Analytics
            </h1>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Today's Attendance</h6>
                            <h2 class="mb-0" id="todayCount">-</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Devices</h6>
                            <h2 class="mb-0" id="activeDevices">-</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-mobile-alt fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Employees</h6>
                            <h2 class="mb-0" id="totalEmployees">-</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">This Week</h6>
                            <h2 class="mb-0" id="weekCount">-</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-week fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-8 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-1"></i>
                        7-Day Attendance Trend
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="attendanceTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-1"></i>
                        Status Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-1"></i>
                        Device Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="deviceUsageChart" height="150"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-1"></i>
                        Hourly Patterns
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="hourlyChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-12">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">Attendance Summary</h5>
                            <p class="card-text">View attendance statistics and trends</p>
                            <a href="#" class="btn btn-primary">View Report</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-3x text-info mb-3"></i>
                            <h5 class="card-title">Scheduler Information</h5>
                            <p class="card-text">View scheduled jobs and next run times</p>
                            <a href="{{ url_for('scheduler_info') }}" class="btn btn-info">View Scheduler</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                            <h5 class="card-title">Error Logs</h5>
                            <p class="card-text">View system errors from last 7 days</p>
                            <a href="{{ url_for('error_logs') }}" class="btn btn-danger">View Error Logs</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-1"></i>
                        Recent Activity (Last 24 Hours)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Employee</th>
                                    <th>Device</th>
                                    <th>Status</th>
                                    <th>Area</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <tr>
                                    <td colspan="5" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js configuration
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.color = '#6c757d';

let attendanceTrendChart, statusChart, deviceUsageChart, hourlyChart;

// Initialize all charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadSummaryCards();
    loadRecentActivity();
    
    // Refresh data every 5 minutes
    setInterval(() => {
        loadSummaryCards();
        loadRecentActivity();
        refreshCharts();
    }, 300000);
});

function initializeCharts() {
    // Attendance Trend Chart
    const trendCtx = document.getElementById('attendanceTrendChart').getContext('2d');
    attendanceTrendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Attendance Count',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Status Breakdown Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#198754',
                    '#dc3545',
                    '#fd7e14',
                    '#6f42c1',
                    '#20c997'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Device Usage Chart
    const deviceCtx = document.getElementById('deviceUsageChart').getContext('2d');
    deviceUsageChart = new Chart(deviceCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Usage Count',
                data: [],
                backgroundColor: '#20c997'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Hourly Patterns Chart
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    hourlyChart = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Attendance Count',
                data: [],
                backgroundColor: '#6f42c1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Load chart data
    refreshCharts();
}

function refreshCharts() {
    // Load attendance trend data
    fetch('/api/reports/attendance_summary')
        .then(response => response.json())
        .then(data => {
            attendanceTrendChart.data.labels = data.map(d => d.day);
            attendanceTrendChart.data.datasets[0].data = data.map(d => d.count);
            attendanceTrendChart.update();
        });

    // Load status breakdown data
    fetch('/api/reports/status_breakdown')
        .then(response => response.json())
        .then(data => {
            statusChart.data.labels = data.map(d => d.status);
            statusChart.data.datasets[0].data = data.map(d => d.count);
            statusChart.update();
        });

    // Load device usage data
    fetch('/api/reports/device_usage')
        .then(response => response.json())
        .then(data => {
            deviceUsageChart.data.labels = data.map(d => d.device_name);
            deviceUsageChart.data.datasets[0].data = data.map(d => d.count);
            deviceUsageChart.update();
        });

    // Load hourly patterns data
    fetch('/api/reports/hourly_patterns')
        .then(response => response.json())
        .then(data => {
            hourlyChart.data.labels = data.map(d => d.hour);
            hourlyChart.data.datasets[0].data = data.map(d => d.count);
            hourlyChart.update();
        });
}

function loadSummaryCards() {
    // Load actual statistics
    fetch('/api/reports/summary_stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('todayCount').textContent = data.today_logs || '0';
            document.getElementById('activeDevices').textContent = data.online_devices || '0';
            document.getElementById('totalEmployees').textContent = data.total_users || '0';
            document.getElementById('weekCount').textContent = data.week_logs || '0';
        })
        .catch(error => {
            console.error('Error loading summary stats:', error);
        });
}

function loadRecentActivity() {
    // Load recent activity data
    fetch('/api/logs?per_page=10')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('recentActivityTable');
            tbody.innerHTML = '';
            
            if (!data.logs || data.logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No recent activity</td></tr>';
                return;
            }
            
            data.logs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.date} ${log.time}</td>
                    <td>${log.user_name}</td>
                    <td>${log.device_name}</td>
                    <td><span class="badge bg-${getStatusColor(log.status)}">${log.status}</span></td>
                    <td>${log.area || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
            document.getElementById('recentActivityTable').innerHTML = 
                '<tr><td colspan="5" class="text-center">Error loading data</td></tr>';
        });
}

function getStatusColor(status) {
    switch(status?.toLowerCase()) {
        case 'check in': return 'success';
        case 'check out': return 'primary';
        case 'break start': return 'warning';
        case 'break end': return 'info';
        default: return 'secondary';
    }
}
</script>
{% endblock %}