{% extends "base.html" %}

{% block title %}Attendance Logs - ZKTeco Attendance Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-list me-2"></i>
                Attendance Logs
            </h1>
            <button id="exportLogs" class="btn btn-success" onclick="exportLogs()" disabled>
                <i class="fas fa-file-excel me-1"></i>Export Excel
            </button>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-2">
                <label for="userIdFilter" class="form-label">User ID</label>
                <input type="text" class="form-control" id="userIdFilter" placeholder="Enter User ID">
            </div>
            <div class="col-md-2">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-2">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-2">
                <label for="deviceFilter" class="form-label">Device</label>
                <select class="form-select" id="deviceFilter">
                    <option value="">All Devices</option>
                    {% for device in devices %}
                    <option value="{{ device.device_id }}">{{ device.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="areaFilter" class="form-label">Area</label>
                <select class="form-select" id="areaFilter">
                    <option value="">All Areas</option>
                    {% for area in areas %}
                    <option value="{{ area.name }}">{{ area.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="exportedFilter" class="form-label">Exported</label>
                <select class="form-select" id="exportedFilter">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-primary" onclick="filterLogs()">
                    <i class="fas fa-search me-1"></i>Filter
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Clear
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
            <div id="logsLoading" class="text-center p-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading logs...</p>
            </div>

            <!-- Logs Container -->
            <div id="logsContainer">
                <div class="text-center p-4">
                    <i class="fas fa-filter fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Please use filters above to load attendance logs</h5>
                    <p class="text-muted">Select date range and other filters, then click search to view logs.</p>
                </div>
            </div>

<!-- Pagination will be inserted here -->
<div id="paginationContainer"></div>
{% endblock %}

{% block scripts %}
<script>
let currentLogs = [];

function filterLogs() {
    const filters = {
        user_id: document.getElementById('userIdFilter').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        device_id: document.getElementById('deviceFilter').value,
        area_id: document.getElementById('areaFilter').value,
        exported: document.getElementById('exportedFilter').value
    };

    // Remove empty filters
    Object.keys(filters).forEach(key => filters[key] === '' && delete filters[key]);

    const queryString = new URLSearchParams(filters).toString();

    fetch(`/api/logs?${queryString}`)
        .then(response => response.json())
        .then(data => {
            currentLogs = data.logs;
            renderLogsTable(data.logs);
            renderPagination(data.pagination);
            document.getElementById('exportLogs').disabled = data.logs.length === 0;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading logs');
        });
}

function renderLogsTable(logs) {
    const container = document.getElementById('logsContainer');

    if (logs.length === 0) {
        container.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No logs found matching the selected filters</h5>
            </div>
        `;
        return;
    }

    let tableHTML = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Device ID</th>
                        <th>Device Name</th>
                        <th>Area</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Exported</th>
                    </tr>
                </thead>
                <tbody>
    `;

    const userIdFilter = document.getElementById('userIdFilter').value;
    const deviceFilter = document.getElementById('deviceFilter').value;
    const areaFilter = document.getElementById('areaFilter').value;
    const statusFilter = document.getElementById('statusFilter') ? document.getElementById('statusFilter').value : ''; // Assuming status filter might be added later
    const exportedFilter = document.getElementById('exportedFilter').value;

    let filteredLogs = [];
    logs.forEach(log => {
        const matchesFilters = 
            (!userIdFilter || log.user_id.toLowerCase().includes(userIdFilter.toLowerCase())) &&
            (!deviceFilter || log.device_id === deviceFilter) &&
            (!areaFilter || log.area === areaFilter) &&
            (!statusFilter || (log.status && log.status.toLowerCase().includes(statusFilter.toLowerCase()))) &&
            (!exportedFilter || (exportedFilter === 'true' ? log.exported : !log.exported));

        if (matchesFilters) {
            filteredLogs.push(log);
        }
    });


    filteredLogs.forEach(log => {
        tableHTML += `
            <tr>
                <td>${log.user_id}</td>
                <td>${log.user_name}</td>
                <td>${log.device_id}</td>
                <td>${log.device_name}</td>
                <td>${log.area || 'N/A'}</td>
                <td>${log.date}</td>
                <td>${log.time}</td>
                <td>
                    <span class="badge bg-${log.status && log.status.toLowerCase().includes('in') ? 'success' : 'warning'}">
                        ${log.status}
                    </span>
                </td>
                <td>
                    <span class="badge bg-${log.exported ? 'success' : 'secondary'}">
                        ${log.exported ? 'Yes' : 'No'}
                    </span>
                </td>
            </tr>
        `;
    });

    tableHTML += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = tableHTML;
}

function renderPagination(pagination) {
    // Pagination logic would go here
    const container = document.getElementById('paginationContainer');
    container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mt-3">
            <span>Showing ${pagination.total} records</span>
        </div>
    `;
}

function clearFilters() {
    document.getElementById('userIdFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('deviceFilter').value = '';
    document.getElementById('areaFilter').value = '';
    document.getElementById('exportedFilter').value = '';

    document.getElementById('logsContainer').innerHTML = `
        <div class="text-center p-4">
            <i class="fas fa-filter fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Please use filters above to load attendance logs</h5>
        </div>
    `;

    document.getElementById('exportLogs').disabled = true;
}

function exportLogs() {
    if (currentLogs.length === 0) {
        alert('No logs to export');
        return;
    }

    const filters = {
        user_id: document.getElementById('userIdFilter').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        device_id: document.getElementById('deviceFilter').value,
        area_id: document.getElementById('areaFilter').value,
        exported: document.getElementById('exportedFilter').value
    };

    const queryString = new URLSearchParams(filters).toString();
    window.open(`/export/logs?${queryString}`, '_blank');
}

function showAlert(message, type) {
    const alertPlaceholder = document.getElementById('alertPlaceholder'); // Assuming you have a placeholder for alerts
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    alertPlaceholder.append(wrapper);
}

function updatePagination(pagination) {
    const container = document.getElementById('paginationContainer');
    if (!pagination) {
        container.innerHTML = '';
        return;
    }
    let paginationHTML = '<nav aria-label="Page navigation"><ul class="pagination justify-content-center">';
    if (pagination.has_previous) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${pagination.page - 1})">Previous</a></li>`;
    } else {
        paginationHTML += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
    }
    for (let i = 1; i <= pagination.total_pages; i++) {
        const activeClass = i === pagination.page ? 'active' : '';
        paginationHTML += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
    }
    if (pagination.has_next) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${pagination.page + 1})">Next</a></li>`;
    } else {
        paginationHTML += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
    }
    paginationHTML += '</ul></nav>';
    container.innerHTML = paginationHTML;
}

function changePage(page) {
    const params = new URLSearchParams();
    params.append('page', page);

    const userId = document.getElementById('userIdFilter').value;
    const deviceId = document.getElementById('filterDeviceId').value;
    const areaId = document.getElementById('filterAreaId').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const exported = document.getElementById('filterExported').value;

    if (userId) params.append('user_id', userId);
    if (deviceId) params.append('device_id', deviceId);
    if (areaId) params.append('area_id', areaId);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (exported) params.append('exported', exported);

    const url = `/api/logs?${params.toString()}`;

    fetch(url)
    .then(response => response.json())
    .then(data => {
        currentLogs = data.logs;
        renderLogsTable(data.logs);
        updatePagination(data.pagination);
        document.getElementById('exportLogs').disabled = data.logs.length === 0;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading logs');
    });
}

function loadLogs() {
    const loadingDiv = document.getElementById('logsLoading');
    const tableDiv = document.getElementById('logsTableContainer');

    loadingDiv.style.display = 'block';
    tableDiv.style.display = 'none';

    const params = new URLSearchParams();

    const userId = document.getElementById('filterUserId').value;
    const deviceId = document.getElementById('filterDeviceId').value;
    const areaId = document.getElementById('filterAreaId').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const exported = document.getElementById('filterExported').value;

    if (userId) params.append('user_id', userId);
    if (deviceId) params.append('device_id', deviceId);
    if (areaId) params.append('area_id', areaId);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (exported) params.append('exported', exported);

    const url = `/api/logs?${params.toString()}`;

    fetch(url)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        loadingDiv.style.display = 'none';
        tableDiv.style.display = 'block';

        if (data.error) {
            showAlert(data.error, 'danger');
            return;
        }

        const tbody = document.getElementById('logsTableBody');
        tbody.innerHTML = '';

        if (data.logs && data.logs.length > 0) {
            data.logs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.user_id || 'N/A'}</td>
                    <td>${log.user_name || 'Unknown'}</td>
                    <td>${log.device_name || 'Unknown'}</td>
                    <td>${log.area || 'N/A'}</td>
                    <td>${log.date || 'N/A'}</td>
                    <td>${log.time || 'N/A'}</td>
                    <td><span class="badge bg-info">${log.status || 'Unknown'}</span></td>
                    <td><span class="badge bg-${log.exported ? 'success' : 'secondary'}">${log.exported ? 'Yes' : 'No'}</span></td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No logs found</td></tr>';
        }

        // Update pagination if available
        if (data.pagination) {
            updatePagination(data.pagination);
        }
    })
    .catch(error => {
        loadingDiv.style.display = 'none';
        tableDiv.style.display = 'block';
        showAlert('Error loading logs: ' + error.message, 'danger');
        console.error('Error:', error);

        // Show empty table on error
        const tbody = document.getElementById('logsTableBody');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading logs</td></tr>';
    });
}

// Don't auto-load logs on page load - wait for user to apply filters
document.addEventListener('DOMContentLoaded', () => {
    // Page loads with empty state by default
    console.log('Logs page loaded - apply filters to view data');
});
</script>
{% endblock %}