{% extends "base.html" %}

{% block title %}Devices - ZKTeco Attendance Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-mobile-alt me-2"></i>
                Device Management
            </h1>
            <div class="btn-group">
                <button class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#areaModal">
                    <i class="fas fa-map-marker-alt me-1"></i>Add Area
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#deviceModal">
                    <i class="fas fa-plus me-1"></i>Add Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Devices Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Name</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Area</th>
                        <th>Status</th>
                        <th>Last Sync</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr data-device-id="{{ device.id }}">
                        <td>{{ device.device_id }}</td>
                        <td>{{ device.name }}</td>
                        <td>{{ device.ip_address }}</td>
                        <td>{{ device.mac_address or 'N/A' }}</td>
                        <td>{{ device.area_obj.name if device.area_obj else 'N/A' }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if device.online_status else 'danger' }}">
                                {{ 'Online' if device.online_status else 'Offline' }}
                            </span>
                        </td>
                        <td>{{ device.last_sync.strftime('%Y-%m-%d %H:%M') if device.last_sync else 'Never' }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="syncDevice({{ device.id }})">
                                    <i class="fas fa-sync"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="beepDevice({{ device.id }})">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editDevice({{ device.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteDevice({{ device.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Device Modal -->
<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add/Edit Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deviceForm">
                    <input type="hidden" id="deviceId">
                    
                    <div class="mb-3">
                        <label for="deviceIdInput" class="form-label">Device ID</label>
                        <input type="text" class="form-control" id="deviceIdInput" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="deviceName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ipAddress" class="form-label">IP Address</label>
                        <input type="text" class="form-control" id="ipAddress" required pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                    </div>
                    
                    <div class="mb-3">
                        <label for="areaSelect" class="form-label">Area</label>
                        <select class="form-select" id="areaSelect">
                            <option value="">Select Area</option>
                            {% for area in areas %}
                            <option value="{{ area.id }}">{{ area.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDevice()">Save Device</button>
            </div>
        </div>
    </div>
</div>

<!-- Area Modal -->
<div class="modal fade" id="areaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="areaForm">
                    <div class="mb-3">
                        <label for="areaName" class="form-label">Area Name</label>
                        <input type="text" class="form-control" id="areaName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveArea()">Save Area</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingDeviceId = null;

function editDevice(deviceId) {
    // This would typically fetch device data via AJAX
    // For now, we'll just set up the modal for editing
    editingDeviceId = deviceId;
    document.getElementById('deviceModal').querySelector('.modal-title').textContent = 'Edit Device';
    
    // You would populate the form fields here with existing device data
    const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
    modal.show();
}

function saveDevice() {
    const form = document.getElementById('deviceForm');
    const formData = new FormData(form);
    
    const deviceData = {
        device_id: document.getElementById('deviceIdInput').value,
        name: document.getElementById('deviceName').value,
        ip_address: document.getElementById('ipAddress').value,
        area_id: document.getElementById('areaSelect').value || null
    };
    
    const url = editingDeviceId ? `/api/devices/${editingDeviceId}` : '/api/devices';
    const method = editingDeviceId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(deviceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the device');
    });
}

function deleteDevice(deviceId) {
    if (confirm('Are you sure you want to delete this device?')) {
        fetch(`/api/devices/${deviceId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the device');
        });
    }
}

// Initialize Socket.IO for device page
const socket = io();

// Handle sync completion
socket.on('sync_complete', function(data) {
    alert(data.message);
    // Update last sync time in the table
    const row = document.querySelector(`[data-device-id="${data.device_id}"]`);
    if (row) {
        const lastSyncCell = row.cells[6]; // Assuming last sync is 7th column (index 6)
        lastSyncCell.textContent = data.last_sync;
    }
    // Re-enable the sync button
    const button = document.querySelector(`[onclick="syncDevice(${data.device_id})"]`);
    if (button) {
        button.innerHTML = '<i class="fas fa-sync"></i>';
        button.disabled = false;
    }
});

// Handle beep completion
socket.on('beep_complete', function(data) {
    alert(data.message);
    // Re-enable the beep button
    const button = document.querySelector(`[onclick="beepDevice(${data.device_id})"]`);
    if (button) {
        button.innerHTML = '<i class="fas fa-volume-up"></i>';
        button.disabled = false;
    }
});

// Handle errors
socket.on('error', function(data) {
    alert('Error: ' + data.message);
    // Re-enable all buttons on error
    document.querySelectorAll('button[disabled]').forEach(btn => {
        btn.disabled = false;
        if (btn.innerHTML.includes('spinner')) {
            if (btn.onclick.toString().includes('sync')) {
                btn.innerHTML = '<i class="fas fa-sync"></i>';
            } else if (btn.onclick.toString().includes('beep')) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
        }
    });
});

function syncDevice(deviceId) {
    const button = event.target;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    // Emit sync request via WebSocket
    socket.emit('manual_device_sync', {device_id: deviceId});
}

function beepDevice(deviceId) {
    const button = event.target;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    // Emit beep request via WebSocket
    socket.emit('device_beep', {device_id: deviceId});
}

// Area management functions
function saveArea() {
    const areaName = document.getElementById('areaName').value;
    
    if (!areaName.trim()) {
        alert('Please enter an area name');
        return;
    }
    
    fetch('/api/areas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({name: areaName})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new area to the device form dropdown
            const areaSelect = document.getElementById('areaSelect');
            const newOption = document.createElement('option');
            newOption.value = data.id;
            newOption.textContent = data.name;
            areaSelect.appendChild(newOption);
            
            // Close the area modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('areaModal'));
            modal.hide();
            
            alert('Area added successfully');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the area');
    });
}

// Reset modals when closed
document.getElementById('deviceModal').addEventListener('hidden.bs.modal', function () {
    editingDeviceId = null;
    document.getElementById('deviceForm').reset();
    document.querySelector('.modal-title').textContent = 'Add Device';
});

document.getElementById('areaModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('areaForm').reset();
});
</script>
{% endblock %}
