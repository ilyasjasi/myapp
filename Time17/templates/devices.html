{% extends "base.html" %}

{% block title %}Devices - ZKTeco Attendance Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-mobile-alt me-2"></i>
                Device Management
            </h1>
            <div class="btn-group">
                <button class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#areaModal">
                    <i class="fas fa-map-marker-alt me-1"></i>Add Area
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#deviceModal">
                    <i class="fas fa-plus me-1"></i>Add Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Devices Table -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title">Devices</h3>
            <div class="card-tools">
                <button class="btn btn-info me-2" onclick="refreshDeviceStatus()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh Status
                </button>
                <a href="/export/devices" class="btn btn-success me-2">
                    <i class="fas fa-file-excel"></i> Export Excel
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="deviceSearch" class="form-control" placeholder="Search devices...">
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Name</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Area</th>
                        <th>Status</th>
                        <th>Device Info</th>
                        <th>Last Sync</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr data-device-id="{{ device.id }}">
                        <td>{{ device.device_id }}</td>
                        <td>{{ device.name }}</td>
                        <td>{{ device.ip_address }}</td>
                        <td>{{ device.mac_address or 'N/A' }}</td>
                        <td>{{ device.area_obj.name if device.area_obj else 'N/A' }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if device.online_status else 'danger' }}">
                                {{ 'Online' if device.online_status else 'Offline' }}
                            </span>
                        </td>
                        <td id="device-info-{{ device.id }}">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadDeviceInfo({{ device.id }})" title="Load Device Info">
                                <i class="fas fa-info-circle"></i> Info
                            </button>
                            <div id="device-info-content-{{ device.id }}" class="mt-2" style="display: none;">
                                <div class="row g-1">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Users:</small>
                                        <span class="badge bg-primary user-count">-</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Templates:</small>
                                        <span class="badge bg-info template-count">-</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Faces:</small>
                                        <span class="badge bg-success face-count">-</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Logs:</small>
                                        <span class="badge bg-warning log-count">-</span>
                                    </div>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">Time: </small>
                                    <small class="device-time">-</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ device.last_sync.strftime('%Y-%m-%d %H:%M') if device.last_sync else 'Never' }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="syncDevice({{ device.id }})" title="Sync">
                                    <i class="fas fa-sync"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="beepDevice({{ device.id }})" title="Beep">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="setDeviceTime({{ device.id }})" title="Set Time">
                                    <i class="fas fa-clock"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editDevice({{ device.id }})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="deleteDeviceLogs({{ device.id }})" title="Delete Logs">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteDevice({{ device.id }})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Device Modal -->
<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deviceForm">
                    <input type="hidden" id="deviceId">
                    <div class="mb-3">
                        <label for="deviceIdInput" class="form-label">Device ID</label>
                        <input type="text" class="form-control" id="deviceIdInput" required>
                    </div>
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="deviceName" required>
                    </div>
                    <div class="mb-3">
                        <label for="ipAddress" class="form-label">IP Address</label>
                        <input type="text" class="form-control" id="ipAddress" required pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                    </div>
                    <div class="mb-3">
                        <label for="areaSelect" class="form-label">Area</label>
                        <select class="form-select" id="areaSelect">
                            <option value="">Select Area</option>
                            {% for area in areas %}
                            <option value="{{ area.id }}">{{ area.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDevice()">Save Device</button>
            </div>
        </div>
    </div>
</div>

<!-- Area Modal -->
<div class="modal fade" id="areaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="areaForm">
                    <div class="mb-3">
                        <label for="areaName" class="form-label">Area Name</label>
                        <input type="text" class="form-control" id="areaName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveArea()">Save Area</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingDeviceId = null;

function editDevice(deviceId) {
    editingDeviceId = deviceId;
    document.getElementById('deviceModal').querySelector('.modal-title').textContent = 'Edit Device';

    // Fetch device data
    fetch(`/api/devices/${deviceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('deviceIdInput').value = data.device.device_id;
                document.getElementById('deviceName').value = data.device.name;
                document.getElementById('ipAddress').value = data.device.ip_address;
                document.getElementById('areaSelect').value = data.device.area_id || '';

                const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
                modal.show();
            } else {
                alert('Error loading device data: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading device data');
        });
}

function saveDevice() {
    const deviceData = {
        device_id: document.getElementById('deviceIdInput').value,
        name: document.getElementById('deviceName').value,
        ip_address: document.getElementById('ipAddress').value,
        area_id: document.getElementById('areaSelect').value || null
    };

    const url = editingDeviceId ? `/api/devices/${editingDeviceId}` : '/api/devices';
    const method = editingDeviceId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(deviceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('deviceModal'));
            modal.hide();
            setTimeout(() => location.reload(), 100);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the device');
    });
}

function deleteDevice(deviceId) {
    if (confirm('Are you sure you want to delete this device?')) {
        fetch(`/api/devices/${deviceId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the device');
        });
    }
}

function syncDevice(deviceId) {
    const button = event.target.closest('button');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    fetch(`/api/devices/${deviceId}/sync`)
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            button.innerHTML = '<i class="fas fa-sync"></i>';
            button.disabled = false;
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error syncing device');
            button.innerHTML = '<i class="fas fa-sync"></i>';
            button.disabled = false;
        });
}

function beepDevice(deviceId) {
    const button = event.target.closest('button');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    fetch(`/api/devices/${deviceId}/beep`)
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
            button.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error beeping device');
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
            button.disabled = false;
        });
}

function setDeviceTime(deviceId) {
    const button = event.target.closest('button');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    fetch(`/api/devices/${deviceId}/set_time`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        button.innerHTML = '<i class="fas fa-clock"></i>';
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error setting device time');
        button.innerHTML = '<i class="fas fa-clock"></i>';
        button.disabled = false;
    });
}

function saveArea() {
    const areaName = document.getElementById('areaName').value;

    if (!areaName.trim()) {
        alert('Please enter an area name');
        return;
    }

    fetch('/api/areas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({name: areaName})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const areaSelect = document.getElementById('areaSelect');
            const newOption = document.createElement('option');
            newOption.value = data.id;
            newOption.textContent = data.name;
            areaSelect.appendChild(newOption);

            const modal = bootstrap.Modal.getInstance(document.getElementById('areaModal'));
            modal.hide();
            alert('Area added successfully');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the area');
    });
}

// Reset modals when closed
document.getElementById('deviceModal').addEventListener('hidden.bs.modal', function () {
    editingDeviceId = null;
    document.getElementById('deviceForm').reset();
    document.querySelector('#deviceModal .modal-title').textContent = 'Add Device';
});

document.getElementById('areaModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('areaForm').reset();
});

// Search functionality
document.getElementById('deviceSearch').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const tableRows = document.querySelectorAll('tbody tr');

    tableRows.forEach(row => {
        const rowText = row.textContent.toLowerCase();
        if (rowText.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Auto-refresh device status every 30 seconds
function refreshDeviceStatus() {
    fetch('/api/devices/status')
        .then(response => response.json())
        .then(devices => {
            devices.forEach(device => {
                const statusCell = document.querySelector(`tr[data-device-id="${device.id}"] td:nth-child(6)`);
                const infoCell = document.getElementById(`device-info-${device.id}`);

                if (statusCell) {
                    statusCell.innerHTML = `<span class="badge bg-${device.online_status ? 'success' : 'danger'}">${device.online_status ? 'Online' : 'Offline'}</span>`;
                }

                if (infoCell) {
                    if (device.online_status && device.user_count !== undefined) {
                        infoCell.innerHTML = `
                            <small>
                                <i class="fas fa-users text-primary"></i> ${device.user_count}<br>
                                <i class="fas fa-fingerprint text-info"></i> ${device.template_count}<br>
                                <i class="fas fa-face-smile text-warning"></i> ${device.face_count}<br>
                                <i class="fas fa-list text-success"></i> ${device.log_count}
                            </small>
                        `;
                    } else {
                        infoCell.innerHTML = '<small class="text-muted"><i class="fas fa-times-circle"></i> Offline</small>';
                    }
                }
            });
        })
        .catch(error => console.error('Error refreshing device status:', error));
}

// Start auto-refresh
setInterval(refreshDeviceStatus, 30000);

// Helper function for alerts
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.getElementById('content').prepend(alertDiv); // Adjust target as needed
}

// Loading overlay functions
function showLoading(message = 'Processing...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loadingOverlay';
    loadingDiv.innerHTML = `
        <div class="d-flex justify-content-center align-items-center position-fixed top-0 start-0 w-100 h-100" style="background: rgba(0,0,0,0.5); z-index: 9999;">
            <div class="text-center text-white">
                <div class="spinner-border" role="status"></div>
                <div class="mt-2">${message}</div>
            </div>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loadingOverlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function addDevice() {
    document.getElementById('addDeviceForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('addDeviceModal'));
    modal.show();
}


// Add Device Form Submission Handler
document.getElementById('addDeviceForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Show immediate loading and close modal
    showLoading('Adding device...');
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Close modal immediately
    const modal = bootstrap.Modal.getInstance(document.getElementById('addDeviceModal'));
    modal.hide();

    fetch('/api/devices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            // Show success message with background processing info
            showNotification(data.message, 'success');
            
            // Show processing overlay
            showProcessingOverlay('Device setup is continuing in background...');
            
            // Refresh page after short delay to show new device
            setTimeout(() => {
                hideProcessingOverlay();
                location.reload();
            }, 2000);
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        alert('Error: ' + error.message);
    });
});

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Processing overlay
function showProcessingOverlay(message) {
    const overlay = document.createElement('div');
    overlay.id = 'processingOverlay';
    overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
    overlay.style.cssText = 'background: rgba(0,0,0,0.7); z-index: 9998;';
    overlay.innerHTML = `
        <div class="bg-white p-4 rounded shadow text-center">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <div class="h5">${message}</div>
        </div>
    `;
    document.body.appendChild(overlay);
}

function hideProcessingOverlay() {
    const overlay = document.getElementById('processingOverlay');
    if (overlay) {
        overlay.remove();
    }
}

// Load device info on demand
function loadDeviceInfo(deviceId) {
    const button = document.querySelector(`button[onclick="loadDeviceInfo(${deviceId})"]`);
    const contentDiv = document.getElementById(`device-info-content-${deviceId}`);
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    
    fetch(`/api/devices/${deviceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const info = data.device_info;
                contentDiv.innerHTML = `
                    <small>
                        <i class="fas fa-users text-primary"></i> Users: ${info.user_count || 0}<br>
                        <i class="fas fa-fingerprint text-info"></i> Templates: ${info.template_count || 0}<br>
                        <i class="fas fa-face-smile text-warning"></i> Faces: ${info.face_count || 0}<br>
                        <i class="fas fa-list text-success"></i> Logs: ${info.log_count || 0}
                        ${info.device_time ? `<br><i class="fas fa-clock text-secondary"></i> Time: ${info.device_time}` : ''}
                    </small>
                `;
                contentDiv.style.display = 'block';
                button.innerHTML = '<i class="fas fa-sync"></i> Refresh';
            } else {
                contentDiv.innerHTML = '<small class="text-danger">Failed to load device info</small>';
                contentDiv.style.display = 'block';
                button.innerHTML = '<i class="fas fa-info-circle"></i> Info';
            }
        })
        .catch(error => {
            contentDiv.innerHTML = '<small class="text-danger">Error loading device info</small>';
            contentDiv.style.display = 'block';
            button.innerHTML = '<i class="fas fa-info-circle"></i> Info';
        })
        .finally(() => {
            button.disabled = false;
        });
}

// Delete device logs with confirmation
function deleteDeviceLogs(deviceId) {
    if (!confirm('Are you sure you want to delete all logs for this device? This action cannot be undone.')) {
        return;
    }
    
    showLoading('Deleting device logs...');
    
    fetch(`/api/devices/${deviceId}/logs`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification('Device logs deleted successfully', 'success');
            // Refresh device info if it's currently displayed
            const contentDiv = document.getElementById(`device-info-content-${deviceId}`);
            if (contentDiv.style.display !== 'none') {
                loadDeviceInfo(deviceId);
            }
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('Error deleting device logs: ' + error.message, 'error');
    });
}

// Function to refresh device status
function refreshDeviceStatus() {
    const refreshBtn = document.querySelector('button[onclick="refreshDeviceStatus()"]');
    const originalText = refreshBtn.innerHTML;
    
    // Show loading state
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    // Force refresh device status
    fetch('/api/devices/status', {
        method: 'GET',
        headers: {
            'Cache-Control': 'no-cache'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Update the device status display
        updateDeviceStatusDisplay(data);
        
        // Reset button
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        
        // Show success message
        showAlert('Device status refreshed successfully', 'success');
    })
    .catch(error => {
        console.error('Error refreshing device status:', error);
        
        // Reset button
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        
        // Show error message
        showAlert('Error refreshing device status', 'danger');
    });
}

// Function to update device status display
function updateDeviceStatusDisplay(devices) {
    devices.forEach(device => {
        const statusElement = document.querySelector(`#device-status-${device.id}`);
        if (statusElement) {
            if (device.online_status) {
                statusElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Online</span>';
            } else {
                statusElement.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Offline</span>';
            }
        }
    });
}

// Function to show alert messages
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the page
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

</script>
<style>
.loading-indicator {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
</style>
{% endblock %}