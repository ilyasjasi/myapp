{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>User Management</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                    <button class="btn btn-success" onclick="exportUsers()">
                        <i class="fas fa-download"></i> Export to Excel
                    </button>
                </div>
            </div>


        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card bg-dark border-secondary">
                    <div class="card-header">
                        <h5 class="mb-0">Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Search Users</label>
                            <input type="text" class="form-control" id="searchUsers" placeholder="Search by name or ID...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Area</label>
                            <select class="form-control" id="filterArea" onchange="applyFilters()">
                                <option value="">All Areas</option>
                                {% for area in areas %}
                                <option value="{{ area.id }}">{{ area.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-control" id="filterStatus" onchange="applyFilters()">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Terminated">Terminated</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Site</label>
                            <select class="form-control" id="filterSite" onchange="applyFilters()">
                                <option value="">All Sites</option>
                                {% for site in sites %}
                                <option value="{{ site }}">{{ site }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Fingerprint</label>
                            <select class="form-control" id="filterFingerprint" onchange="applyFilters()">
                                <option value="">All</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Face</label>
                            <select class="form-control" id="filterFace" onchange="applyFilters()">
                                <option value="">All</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Bulk Actions -->
            <div class="card mb-4" id="bulkActionsCard" style="display: none;">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <span id="selectedCount">0</span> users selected
                        </div>
                        <div class="col-md-4 text-end">
                            <select class="form-control d-inline-block w-auto me-2" id="bulkAction">
                                <option value="">Select Action</option>
                                <option value="area">Change Area</option>
                                <option value="site">Change Site</option>
                                <option value="status">Change Status</option>
                            </select>
                            <select class="form-control d-inline-block w-auto me-2" id="bulkValue" style="display: none;">
                            </select>
                            <button class="btn btn-warning" onclick="applyBulkAction()">Apply</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Users table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="usersTable">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Job Description</th>
                            <th>Status</th>
                            <th>Area</th>
                            <th>Site</th>
                            <th>Fingerprint</th>
                            <th>Face</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        {% for user in users %}
                        <tr data-user-id="{{ user.id }}" data-area-id="{{ user.area_id or '' }}" data-status="{{ user.status }}" data-site="{{ user.site or '' }}" data-fingerprint="{{ 'true' if user.has_fingerprint else 'false' }}" data-face="{{ 'true' if user.has_face else 'false' }}">
                            <td>
                                <input type="checkbox" class="user-select" value="{{ user.id }}">
                            </td>
                            <td>{{ user.user_id }}</td>
                            <td>{{ user.first_name }} {{ user.last_name }}</td>
                            <td>{{ user.job_description or '-' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if user.status == 'Active' else 'danger' }}">
                                    {{ user.status }}
                                </span>
                            </td>
                            <td>{{ user.area_obj.name if user.area_obj else '-' }}</td>
                            <td>{{ user.site or '-' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if user.has_fingerprint else 'secondary' }}">
                                    {{ 'Yes' if user.has_fingerprint else 'No' }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if user.has_face else 'secondary' }}">
                                    {{ 'Yes' if user.has_face else 'No' }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-warning" onclick="editUser({{ user.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="syncUser({{ user.id }})">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">User ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="user_id" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control" name="last_name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Job Description</label>
                        <input type="text" class="form-control" name="job_description">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-control" name="status">
                            <option value="Active">Active</option>
                            <option value="Terminated">Terminated</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Area</label>
                        <select class="form-control" name="area_id">
                            <option value="">Select Area</option>
                            {% for area in areas %}
                            <option value="{{ area.id }}">{{ area.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Site</label>
                        <input type="text" class="form-control" name="site">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" id="addUserSpinner"></span>
                        Add User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <input type="hidden" name="user_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">User ID (Read Only)</label>
                        <input type="text" class="form-control" name="user_id_display" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control" name="last_name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Job Description</label>
                        <input type="text" class="form-control" name="job_description">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-control" name="status">
                            <option value="Active">Active</option>
                            <option value="Terminated">Terminated</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Area</label>
                        <select class="form-control" name="area_id">
                            <option value="">Select Area</option>
                            {% for area in areas %}
                            <option value="{{ area.id }}">{{ area.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm">
        <div class="modal-content bg-dark">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p id="loadingText">Processing...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Loading overlay functions
function showLoading(message = 'Processing...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loadingOverlay';
    loadingDiv.innerHTML = `
        <div class="d-flex justify-content-center align-items-center position-fixed top-0 start-0 w-100 h-100" style="background: rgba(0,0,0,0.5); z-index: 9999;">
            <div class="text-center text-white">
                <div class="spinner-border" role="status"></div>
                <div class="mt-2">${message}</div>
            </div>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loadingOverlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

let selectedUsers = new Set();

document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    document.getElementById('searchUsers').addEventListener('input', function() {
        applyFilters();
    });

    // Select all functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.user-select');
        checkboxes.forEach(cb => {
            cb.checked = this.checked;
            if (this.checked) {
                selectedUsers.add(cb.value);
            } else {
                selectedUsers.delete(cb.value);
            }
        });
        updateBulkActions();
    });

    // Individual checkbox handling
    document.querySelectorAll('.user-select').forEach(cb => {
        cb.addEventListener('change', function() {
            if (this.checked) {
                selectedUsers.add(this.value);
            } else {
                selectedUsers.delete(this.value);
            }
            updateBulkActions();
        });
    });

    // Bulk action type change
    document.getElementById('bulkAction').addEventListener('change', function() {
        const bulkValue = document.getElementById('bulkValue');
        bulkValue.innerHTML = '';
        bulkValue.style.display = 'none';

        if (this.value === 'area') {
            bulkValue.innerHTML = `
                <option value="">Select Area</option>
                {% for area in areas %}
                <option value="{{ area.id }}">{{ area.name }}</option>
                {% endfor %}
            `;
            bulkValue.style.display = 'inline-block';
        } else if (this.value === 'status') {
            bulkValue.innerHTML = `
                <option value="">Select Status</option>
                <option value="Active">Active</option>
                <option value="Terminated">Terminated</option>
            `;
            bulkValue.style.display = 'inline-block';
        } else if (this.value === 'site') {
            bulkValue.innerHTML = `<option value="">Enter Site</option>`;
            bulkValue.style.display = 'inline-block';
        }
    });
});

function applyFilters() {
    const search = document.getElementById('searchUsers').value.toLowerCase();
    const area = document.getElementById('filterArea').value;
    const status = document.getElementById('filterStatus').value;
    const site = document.getElementById('filterSite').value;
    const fingerprint = document.getElementById('filterFingerprint').value;
    const face = document.getElementById('filterFace').value;

    const rows = document.querySelectorAll('#usersTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const rowArea = row.dataset.areaId;
        const rowStatus = row.dataset.status;
        const rowSite = row.dataset.site;
        const rowFingerprint = row.dataset.fingerprint;
        const rowFace = row.dataset.face;

        let show = true;

        if (search && !text.includes(search)) show = false;
        if (area && rowArea !== area) show = false;
        if (status && rowStatus !== status) show = false;
        if (site && rowSite !== site) show = false;
        if (fingerprint && rowFingerprint !== fingerprint) show = false;
        if (face && rowFace !== face) show = false;

        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('searchUsers').value = '';
    document.getElementById('filterArea').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterSite').value = '';
    document.getElementById('filterFingerprint').value = '';
    document.getElementById('filterFace').value = '';
    applyFilters();
}

function updateBulkActions() {
    const count = selectedUsers.size;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('bulkActionsCard').style.display = count > 0 ? 'block' : 'none';
}

function applyBulkAction() {
    const action = document.getElementById('bulkAction').value;
    const value = document.getElementById('bulkValue').value;

    if (!action || !value || selectedUsers.size === 0) {
        alert('Please select action, value and users');
        return;
    }

    showLoading('Updating users...');

    const updates = {};
    if (action === 'area') updates.area_id = value;
    else if (action === 'status') updates.status = value;
    else if (action === 'site') updates.site = value;

    fetch('/api/users/bulk_update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_ids: Array.from(selectedUsers),
            updates: updates
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert('Users updated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Error updating users', 'danger');
    });
}

function exportUsers() {
    window.location.href = '/export/users';
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const tableRows = document.querySelectorAll('#usersTable tbody tr');

    tableRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Add User Form
document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();

    showLoading('Adding user...');
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    fetch('/api/users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Error adding user', 'danger');
    });
});

function editUser(userId) {
    fetch(`/api/users/${userId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const form = document.getElementById('editUserForm');
            const user = data.user;

            form.querySelector('input[name="user_id"]').value = user.id;
            form.querySelector('input[name="user_id_display"]').value = user.user_id;
            form.querySelector('input[name="first_name"]').value = user.first_name;
            form.querySelector('input[name="last_name"]').value = user.last_name || '';
            form.querySelector('input[name="job_description"]').value = user.job_description || '';
            form.querySelector('select[name="status"]').value = user.status;
            form.querySelector('select[name="area_id"]').value = user.area_id || '';

            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }
    });
}

// Edit User Form
document.getElementById('editUserForm').addEventListener('submit', function(e) {
    e.preventDefault();

    showLoading('Updating user...');
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    const userId = data.user_id;

    fetch(`/api/users/${userId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.message, 'danger');
        }
    });
});

function syncUser(userId) {
    if (confirm('Are you sure you want to sync this user to all devices in their area?')) {
        showLoading('Syncing user...');
        fetch(`/api/users/${userId}/sync`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showAlert(data.message, 'success');
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
    }
}

// Loading state management
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}