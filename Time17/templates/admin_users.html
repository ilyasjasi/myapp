{% extends "base.html" %}

{% block title %}System Users - ZKTeco Attendance Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-user-shield me-2"></i>
                System User Management
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#adminUserModal">
                <i class="fas fa-plus me-1"></i>Add Admin User
            </button>
        </div>
    </div>
</div>

<!-- Admin Users Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Force Password Change</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr data-user-id="{{ user.id }}">
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td>
                            <span class="badge bg-{{ 'warning' if user.force_change else 'success' }}">
                                {{ 'Yes' if user.force_change else 'No' }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editAdminUser({{ user.id }}, '{{ user.username }}', {{ user.force_change|lower }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if user.id != current_user.id %}
                                <button class="btn btn-outline-danger" onclick="deleteAdminUser({{ user.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Admin User Modal -->
<div class="modal fade" id="adminUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add/Edit Admin User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adminUserForm">
                    <input type="hidden" id="adminUserId">
                    
                    <div class="mb-3">
                        <label for="adminUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="adminUsername" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="adminPassword" required>
                        <div class="form-text">Leave blank when editing to keep current password</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="forceChange">
                            <label class="form-check-label" for="forceChange">
                                Force password change on next login
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAdminUser()">Save User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingAdminUserId = null;

function editAdminUser(userId, username, forceChange) {
    editingAdminUserId = userId;
    document.getElementById('adminUserId').value = userId;
    document.getElementById('adminUsername').value = username;
    document.getElementById('adminPassword').value = '';
    document.getElementById('forceChange').checked = forceChange;
    
    document.getElementById('adminUserModal').querySelector('.modal-title').textContent = 'Edit Admin User';
    document.getElementById('adminPassword').required = false;
    
    const modal = new bootstrap.Modal(document.getElementById('adminUserModal'));
    modal.show();
}

function saveAdminUser() {
    const form = document.getElementById('adminUserForm');
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    const forceChange = document.getElementById('forceChange').checked;
    
    if (!username.trim()) {
        alert('Please enter a username');
        return;
    }
    
    if (!editingAdminUserId && !password.trim()) {
        alert('Please enter a password for new users');
        return;
    }
    
    const userData = {
        username: username,
        force_change: forceChange
    };
    
    if (password.trim()) {
        userData.password = password;
    }
    
    const url = editingAdminUserId ? `/api/admin_users/${editingAdminUserId}` : '/api/admin_users';
    const method = editingAdminUserId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the admin user');
    });
}

function deleteAdminUser(userId) {
    if (confirm('Are you sure you want to delete this admin user?')) {
        fetch(`/api/admin_users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the admin user');
        });
    }
}

// Reset modal when closed
document.getElementById('adminUserModal').addEventListener('hidden.bs.modal', function () {
    editingAdminUserId = null;
    document.getElementById('adminUserForm').reset();
    document.querySelector('.modal-title').textContent = 'Add Admin User';
    document.getElementById('adminPassword').required = true;
});
</script>
{% endblock %}